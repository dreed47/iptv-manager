<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>IPTV Manager</title>
    <style>
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 5px;
      }
      /* limit column widths for long multiline cells */
      .col-limited {
        max-width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      /* allow wrapping inside edit textareas but keep visual width limited */
      .textarea-limited {
        max-width: 220px;
        width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: pre-wrap; /* preserve newlines but allow wrap */
      }
      th {
        background-color: #f2f2f2;
      }
      input[type="text"] {
        width: 100%;
        margin: 2px 0;
        max-width: 200px;
      }
      textarea {
        width: 100%;
        margin: 2px 0;
        max-width: 200px;
        height: 80px;
        resize: vertical;
        font-family: Arial, sans-serif;
        font-size: 12px;
      }
      button {
        margin: 2px;
      }
      .error {
        color: red;
      }
      .discovery-controls {
        margin: 20px 0;
        padding: 10px;
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      }
      .success {
        color: green;
      }
      .stream-url {
        background-color: #f0f8ff;
        padding: 8px;
        margin: 5px 0;
        border-radius: 4px;
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
      }
      .copy-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 8px;
      }
      .copy-btn:hover {
        background-color: #45a049;
      }
      .form-group {
        margin-bottom: 8px;
      }
      .form-label {
        display: block;
        font-weight: bold;
        margin-bottom: 2px;
        font-size: 12px;
      }
      .form-help {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
      }
      .channel-row {
        vertical-align: top;
      }
    </style>
  </head>
  <body>
    <h1>IPTV Configurations</h1>

    <div style="margin-bottom: 10px">
      <form method="POST" action="/hdhr/enable" style="display: inline">
        {% if not hdhr_running %}
        <button type="submit">Enable Discovery (for Plex)</button>
        {% endif %}
      </form>
      <form method="POST" action="/hdhr/disable" style="display: inline">
        {% if hdhr_running %}
        <button type="submit">Disable Discovery</button>
        {% endif %}
      </form>
      <span style="margin-left: 12px; font-size: 12px; color: #666"
        >SSDP discovery is {% if hdhr_running %}enabled{% else %}disabled{%
        endif %}</span
      >
    </div>

    {% if success %}
    <p class="success">{{ success }}</p>
    {% endif %} {% if error %}
    <p class="error">{{ error }}</p>
    {% endif %}

    <!-- List of items -->
    <table>
      <tr>
        <th>Name</th>
        <th>Server URL</th>
        <th>Username</th>
        <th>Password</th>
        <th>Languages</th>
        <th class="col-limited">Includes</th>
        <th class="col-limited">Excludes</th>
        <th class="col-limited">EPG Channels</th>
        <th>Actions</th>
        <th>Downloads & Streaming</th>
      </tr>
      {% for item in items %}
      <tr class="channel-row">
        <td>{{ item.name }}</td>
        <td>{{ item.server_url }}</td>
        <td>{{ item.username }}</td>
        <td>{{ item.user_pass }}</td>
        <td>{{ item.languages }}</td>
        <td
          class="col-limited"
          title="{{ item.includes }}"
          style="white-space: pre-line"
        >
          {{ item.includes | replace(',', ' ') }}
        </td>
        <td class="col-limited" title="{{ item.excludes }}">
          {{ item.excludes }}
        </td>
        <td class="col-limited" title="{{ item.epg_channels }}">
          {{ item.epg_channels }}
        </td>
        <td>
          <form method="POST" action="/">
            <input type="hidden" name="item_id" value="{{ item.id }}" />

            <div class="form-group">
              <label class="form-label" for="name_{{ item.id }}">Name:</label>
              <input
                type="text"
                id="name_{{ item.id }}"
                name="new_name"
                value="{{ item.name }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="server_url_{{ item.id }}"
                >Server URL:</label
              >
              <input
                type="text"
                id="server_url_{{ item.id }}"
                name="new_server_url"
                value="{{ item.server_url }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="username_{{ item.id }}"
                >Username:</label
              >
              <input
                type="text"
                id="username_{{ item.id }}"
                name="new_username"
                value="{{ item.username }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="user_pass_{{ item.id }}"
                >Password:</label
              >
              <input
                type="text"
                id="user_pass_{{ item.id }}"
                name="new_user_pass"
                value="{{ item.user_pass }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="languages_{{ item.id }}"
                >Languages:</label
              >
              <textarea
                id="languages_{{ item.id }}"
                name="new_languages"
                placeholder="One language code per line&#10;Example:&#10;fr&#10;en&#10;es"
                maxlength="200"
              >
{{ item.languages | replace(',', '
') }}</textarea
              >
              <div class="form-help">
                Extracted from tvg-name prefix like "FR - Show Name"
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="includes_{{ item.id }}"
                >Includes:</label
              >
              <textarea
                id="includes_{{ item.id }}"
                name="new_includes"
                class="textarea-limited"
                placeholder="One keyword per line&#10;Example:&#10;100|hbo&#10;200|premium&#10;300|sports"
                maxlength="10000"
                rows="45"
                style="height: 250px"
              >
{{ item.includes | replace(',', '
') }}</textarea
              >
              <div class="form-help">
                Overrides excludes - channels containing these words will be
                included. Format: number|keyword (e.g., 100|ESPN)
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="excludes_{{ item.id }}"
                >Excludes:</label
              >
              <textarea
                id="excludes_{{ item.id }}"
                name="new_excludes"
                class="textarea-limited"
                placeholder="One keyword per line&#10;Example:&#10;telemundo&#10;sling&#10;adult"
                maxlength="200"
              >
{{ item.excludes | replace(',', '
') }}</textarea
              >
              <div class="form-help">
                Excludes channels containing these words (unless also in
                includes)
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="epg_channels_{{ item.id }}"
                >EPG Channels:</label
              >
              <textarea
                id="epg_channels_{{ item.id }}"
                name="new_epg_channels"
                placeholder="One channel name per line&#10;Example:&#10;US: CW PITTSBURGH&#10;US: FOX NEWS&#10;NFL REDZONE"
                maxlength="1000"
                rows="4"
              >
{{ item.epg_channels }}</textarea
              >
              <div class="form-help">
                One channel name per line for EPG filtering (exact match)
              </div>
            </div>

            <button type="submit" name="edit" value="edit">Save</button>
            <button type="submit" name="delete" value="delete">Delete</button>
          </form>
          <form method="POST" action="/generate_m3u">
            <input type="hidden" name="item_id" value="{{ item.id }}" />
            <button type="submit">Fetch M3U</button>
          </form>
          <form method="POST" action="/generate_filtered_m3u">
            <input type="hidden" name="item_id" value="{{ item.id }}" />
            <button type="submit">Fetch Filtered M3U</button>
          </form>
        </td>
        <td>
          {% if item.has_m3u %}
          <a href="/download_m3u/{{ item.id }}" download>Download M3U</a><br />
          {% endif %} {% if item.has_filtered %}
          <a href="/download_filtered_m3u/{{ item.id }}" download
            >Download Filtered M3U</a
          ><br />
          <!-- Streaming URL Section -->
          <div style="margin-top: 8px">
            <strong>Streaming URL:</strong>
            <div class="stream-url">
              <span id="stream-url-text-{{ item.id }}"
                >{{ item.stream_url }}</span
              >
              <button class="copy-btn" onclick="copyStreamUrl('{{ item.id }}')">
                Copy
              </button>
            </div>
            <small>Use this URL in your IPTV player</small>
          </div>
          <!-- Add EPG streaming link -->
          <div style="margin-top: 8px">
            <strong>EPG URL:</strong>
            <div class="stream-url">
              {{ item.epg_url }}
              <button class="copy-btn" onclick="copyEpgUrl('{{ item.id }}')">
                Copy
              </button>
            </div>
          </div>
          <!-- HDHomeRun helper links -->
          <div style="margin-top: 8px">
            <strong>HDHR Links:</strong><br />
            <a href="/discover.json" target="_blank">discover.json</a><br />
            <a href="/lineup_status.json" target="_blank">lineup_status.json</a
            ><br />
            <a href="/lineup.json" target="_blank">lineup.json</a><br />
            <a href="/hdhr/debug_lineup" target="_blank">debug_lineup</a>
          </div>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>

    <!-- Add new item -->
    <h2>Add New IPTV Configuration</h2>
    <form method="POST" action="/">
      <div class="form-group">
        <label class="form-label" for="name">Name:</label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Configuration Name"
          maxlength="50"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="server_url">Server URL:</label>
        <input
          type="text"
          id="server_url"
          name="server_url"
          placeholder="http://cf.vtsp.cyou:8080"
          maxlength="50"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="username">Username:</label>
        <input
          type="text"
          id="username"
          name="username"
          placeholder="Username"
          maxlength="50"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="user_pass">Password:</label>
        <input
          type="text"
          id="user_pass"
          name="user_pass"
          placeholder="Password"
          maxlength="50"
          required
        />
      </div>

      <button type="submit" name="add" value="add">Add</button>
    </form>

    <script>
      function copyStreamUrl(itemId) {
        const streamUrlElement = document.getElementById(
          `stream-url-text-${itemId}`
        );
        if (!streamUrlElement) {
          console.error("Stream URL element not found for item:", itemId);
          return;
        }

        const streamUrl = streamUrlElement.textContent.trim();

        if (!streamUrl) {
          console.error("Stream URL is empty for item:", itemId);
          return;
        }

        console.log("Copying URL:", streamUrl); // Debug log

        navigator.clipboard
          .writeText(streamUrl)
          .then(function () {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.backgroundColor = "#45a049";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.backgroundColor = "#4CAF50";
            }, 2000);
          })
          .catch(function (err) {
            console.error("Could not copy text: ", err);
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = streamUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.backgroundColor = "#45a049";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.backgroundColor = "#4CAF50";
            }, 2000);
          });
      }
    </script>
  </body>
</html>
