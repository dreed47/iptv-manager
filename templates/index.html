<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>IPTV Manager</title>
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        color: #333;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 30px;
      }
      
      h1 {
        color: #667eea;
        margin: 0 0 10px 0;
        font-size: 32px;
        font-weight: 600;
      }
      
      h2 {
        color: #764ba2;
        font-size: 24px;
        font-weight: 600;
        margin: 30px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }
      
      .error {
        background-color: #fee;
        color: #c33;
        padding: 12px 16px;
        border-radius: 6px;
        border-left: 4px solid #c33;
        margin: 15px 0;
      }
      
      .success {
        background-color: #efe;
        color: #2d7a2d;
        padding: 12px 16px;
        border-radius: 6px;
        border-left: 4px solid #2d7a2d;
        margin: 15px 0;
      }
      
      .discovery-controls {
        margin: 20px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .discovery-controls strong {
        font-size: 18px;
        color: #667eea;
        display: block;
        margin-bottom: 12px;
      }
      
      /* Configuration Card Styles */
      .config-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: box-shadow 0.3s ease;
      }
      
      .config-card:hover {
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
      }
      
      .card-header {
        display: grid;
        grid-template-columns: 2fr 2fr 1.5fr 1.5fr;
        gap: 16px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f5f5f5;
        margin-bottom: 20px;
      }
      
      .card-body {
        display: grid;
        grid-template-columns: 1fr 2fr 2fr 1.5fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .card-footer {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 24px;
        padding-top: 20px;
        border-top: 2px solid #f5f5f5;
      }
      
      .field-group {
        display: flex;
        flex-direction: column;
      }
      
      .field-label {
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #667eea;
        margin-bottom: 6px;
      }
      
      .field-value {
        font-size: 14px;
        color: #333;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }
      
      .field-value-multi {
        font-size: 13px;
        color: #555;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        max-height: 120px;
        overflow-y: auto;
        white-space: pre-line;
        line-height: 1.6;
      }
      
      /* Form Styles */
      .form-group {
        margin-bottom: 12px;
      }
      
      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 13px;
        color: #555;
      }
      
      .form-help {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        font-style: italic;
      }
      
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        font-family: inherit;
      }
      
      input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 13px;
        resize: vertical;
        font-family: 'Courier New', monospace;
        line-height: 1.5;
        transition: border-color 0.3s ease;
      }
      
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      /* Button Styles */
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      button[type="submit"][name="edit"],
      button[type="submit"][value="add"] {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      button[type="submit"][name="edit"]:hover,
      button[type="submit"][value="add"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }
      
      button[type="submit"][name="delete"] {
        background: #e74c3c;
        color: white;
      }
      
      button[type="submit"][name="delete"]:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
      }
      
      button[type="submit"]:not([name="edit"]):not([name="delete"]):not([value="add"]) {
        background: #3498db;
        color: white;
      }
      
      button[type="submit"]:not([name="edit"]):not([name="delete"]):not([value="add"]):hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
      }
      
      .copy-btn {
        background: #27ae60;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
        transition: all 0.3s ease;
      }
      
      .copy-btn:hover {
        background: #229954;
        transform: translateY(-1px);
      }
      
      /* Actions and Links Section */
      .actions-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .actions-section form {
        margin: 0;
      }
      
      .links-section {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }
      
      .links-section h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .stream-url {
        background-color: #e8f5e9;
        padding: 10px 12px;
        margin: 8px 0;
        border-radius: 6px;
        word-break: break-all;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        border: 1px solid #c8e6c9;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .link-item {
        margin: 6px 0;
      }
      
      .link-item a {
        color: #667eea;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
      }
      
      .link-item a:hover {
        color: #764ba2;
        text-decoration: underline;
      }
      
      /* Add New Form */
      .add-new-form {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
      }
      
      @media (max-width: 1200px) {
        .card-header {
          grid-template-columns: 1fr 1fr;
        }
        
        .card-body {
          grid-template-columns: 1fr;
        }
        
        .card-footer {
          grid-template-columns: 1fr;
        }
      }
      
      @media (max-width: 768px) {
        .card-header {
          grid-template-columns: 1fr;
        }
        
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé¨ IPTV Manager</h1>
      <p style="color: #666; margin-top: 0;">Manage your IPTV configurations and playlists</p>

      <div class="discovery-controls">
        <strong>üîç HDHomeRun Discovery (SSDP)</strong>
        <div style="margin-top: 8px">
          {% if can_enable_ssdp %}
            <form method="POST" action="/hdhr/enable" style="display: inline">
              {% if not hdhr_running %}
              <button type="submit">Enable Discovery (for Plex)</button>
              {% endif %}
            </form>
            <form method="POST" action="/hdhr/disable" style="display: inline">
              {% if hdhr_running %}
              <button type="submit">Disable Discovery</button>
              {% endif %}
            </form>
            <span style="margin-left: 12px; font-size: 13px; color: #555; font-weight: 500;">
              Status: <strong style="color: {% if hdhr_running %}#27ae60{% else %}#95a5a6{% endif %}">
                {% if hdhr_running %}Enabled ‚úì{% else %}Disabled{% endif %}
              </strong>
            </span>
          {% else %}
            <!-- Collapsible macOS warning - collapsed by default -->
            <!-- DEBUG: can_enable_ssdp={{ can_enable_ssdp }}, ssdp_disabled_by_env={{ ssdp_disabled_by_env }} -->
            <div style="margin-top: 8px;">
              <button 
                type="button"
                onclick="toggleMacOSInstructions(this)"
                style="background: transparent; border: 1px solid #e67e22; color: #e67e22; padding: 8px 16px; font-size: 13px; cursor: pointer; border-radius: 4px; font-weight: 500; margin-bottom: 12px;"
              >
                ‚ö†Ô∏è macOS: Auto-discovery disabled (click for details)
              </button>
              
              <div id="macos-instructions" style="display: none; margin-top: 12px; padding: 16px; background: #fff3cd; border-left: 4px solid #e67e22; border-radius: 4px;">
                <p style="margin: 0 0 12px 0; color: #e67e22; font-size: 14px; font-weight: 500;">
                  ‚ö†Ô∏è Auto-discovery is disabled by default on macOS to prevent 4-5 minute startup hangs.
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; color: #27ae60; font-weight: 600;">
                  ‚úì Recommended Approach: Manually add the HDHomeRun device in Plex instead of using auto-discovery.
                </p>
                <p style="margin: 0 0 16px 0; font-size: 13px; color: #555;">
                  In Plex, go to Settings ‚Üí Live TV & DVR ‚Üí Set Up Plex DVR ‚Üí Enter the network address manually:<br/>
                  <code style="background: #34495e; color: #ecf0f1; padding: 4px 8px; border-radius: 4px; font-size: 12px;">http://&lt;your-ip&gt;:5005</code>
                </p>
                
                <p style="margin: 16px 0 8px 0; font-size: 13px; color: #555; font-weight: 600;">
                  If you really want auto-discovery on macOS:
                </p>
                <ol style="margin: 4px 0 0 20px; font-size: 12px; color: #666; line-height: 1.8;">
                  <li>Stop the container: <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">docker-compose down</code></li>
                  <li>Edit your <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">.env</code> file: set <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">HDHR_DISABLE_SSDP=0</code></li>
                  <li>Uncomment port 1900/udp in <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">docker-compose.yml</code></li>
                  <li>Restart: <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">docker-compose -f docker-compose.yml -f docker-compose-macos.yml up</code></li>
                  <li><strong style="color: #e74c3c;">Warning:</strong> First startup will hang for 4-5 minutes due to macOS Docker UDP port binding issue</li>
                </ol>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      {% if success %}
      <p class="success">‚úì {{ success }}</p>
      {% endif %}
      
      {% if error %}
      <p class="error">‚úó {{ error }}</p>
      {% endif %}

      <!-- Configuration Cards -->
      <h2>üìã IPTV Configurations</h2>
      
      {% for item in items %}
      <div class="config-card">
        <form method="POST" action="/">
          <input type="hidden" name="item_id" value="{{ item.id }}" />
          
          <!-- Card Header: Name, Server, Username, Password -->
          <div class="card-header">
            <div class="form-group">
              <label class="form-label" for="name_{{ item.id }}">Configuration Name</label>
              <input
                type="text"
                id="name_{{ item.id }}"
                name="new_name"
                value="{{ item.name }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="server_url_{{ item.id }}">Server URL</label>
              <input
                type="text"
                id="server_url_{{ item.id }}"
                name="new_server_url"
                value="{{ item.server_url }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="username_{{ item.id }}">Username</label>
              <input
                type="text"
                id="username_{{ item.id }}"
                name="new_username"
                value="{{ item.username }}"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="user_pass_{{ item.id }}">Password</label>
              <input
                type="text"
                id="user_pass_{{ item.id }}"
                name="new_user_pass"
                value="{{ item.user_pass }}"
                maxlength="50"
                required
              />
            </div>
          </div>

          <!-- Card Body: Languages, Includes, Excludes, EPG Channels -->
          <div class="card-body">
            <div class="form-group">
              <label class="form-label" for="languages_{{ item.id }}">Languages</label>
              <textarea
                id="languages_{{ item.id }}"
                name="new_languages"
                placeholder="One per line&#10;fr&#10;en&#10;es"
                maxlength="200"
                rows="4"
              >{{ item.languages | replace(',', '\n') }}</textarea>
              <div class="form-help">
                Language codes from tvg-name prefix (e.g., "FR - Show Name")
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="includes_{{ item.id }}">Includes (Priority)</label>
              <textarea
                id="includes_{{ item.id }}"
                name="new_includes"
                placeholder="One per line&#10;100|hbo&#10;200|premium&#10;300|sports"
                maxlength="10000"
                rows="8"
              >{{ item.includes | replace(',', '\n') }}</textarea>
              <div class="form-help">
                Overrides excludes. Format: number|keyword (e.g., 100|ESPN)
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="excludes_{{ item.id }}">Excludes</label>
              <textarea
                id="excludes_{{ item.id }}"
                name="new_excludes"
                placeholder="One per line&#10;telemundo&#10;sling&#10;adult"
                maxlength="200"
                rows="4"
              >{{ item.excludes | replace(',', '\n') }}</textarea>
              <div class="form-help">
                Exclude channels containing these keywords
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="epg_channels_{{ item.id }}">EPG Channels</label>
              <textarea
                id="epg_channels_{{ item.id }}"
                name="new_epg_channels"
                placeholder="One per line&#10;US: CW PITTSBURGH&#10;US: FOX NEWS&#10;NFL REDZONE"
                maxlength="1000"
                rows="4"
              >{{ item.epg_channels }}</textarea>
              <div class="form-help">
                Channel names for EPG filtering (exact match)
              </div>
            </div>
          </div>

          <!-- Card Footer: Actions and Streaming Links -->
          <div class="card-footer">
            <div class="actions-section">
              <div style="margin-bottom: 12px;">
                <strong style="color: #667eea; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Actions</strong>
              </div>
              <button type="submit" name="edit" value="edit">üíæ Save Changes</button>
              <button type="submit" name="delete" value="delete">üóëÔ∏è Delete</button>
        </form>
              <form method="POST" action="/generate_m3u" style="margin: 0;">
                <input type="hidden" name="item_id" value="{{ item.id }}" />
                <button type="submit">üì• Fetch M3U</button>
              </form>
              <form method="POST" action="/generate_filtered_m3u" style="margin: 0;">
                <input type="hidden" name="item_id" value="{{ item.id }}" />
                <button type="submit">üîç Fetch Filtered M3U</button>
              </form>
            </div>

            <div class="links-section">
              <h3>üì° Downloads & Streaming</h3>
              
              {% if item.has_m3u %}
              <div class="link-item">
                <a href="/download_m3u/{{ item.id }}" download>üìÑ Download M3U Playlist</a>
              </div>
              {% endif %}
              
              {% if item.has_filtered %}
              <div class="link-item">
                <a href="/download_filtered_m3u/{{ item.id }}" download>üìÑ Download Filtered M3U</a>
              </div>
              
              <!-- Streaming URL Section -->
              <div style="margin-top: 12px;">
                <strong style="font-size: 12px; color: #667eea;">M3U Streaming URL:</strong>
                <div class="stream-url">
                  <span id="stream-url-text-{{ item.id }}" style="flex: 1;">{{ item.stream_url }}</span>
                  <button class="copy-btn" onclick="copyStreamUrl('{{ item.id }}')">
                    üìã Copy
                  </button>
                </div>
              </div>
              
              <!-- EPG streaming link -->
              <div style="margin-top: 12px;">
                <strong style="font-size: 12px; color: #667eea;">EPG URL:</strong>
                <div class="stream-url">
                  <span style="flex: 1;">{{ item.epg_url }}</span>
                  <button class="copy-btn" onclick="copyEpgUrl('{{ item.id }}')">
                    üìã Copy
                  </button>
                </div>
              </div>
              
              <!-- HDHomeRun helper links -->
              <div style="margin-top: 16px;">
                <strong style="font-size: 12px; color: #667eea;">HDHomeRun API:</strong>
                <div style="margin-top: 6px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
                  <a href="/discover.json" target="_blank" style="font-size: 12px;">discover.json</a>
                  <a href="/lineup_status.json" target="_blank" style="font-size: 12px;">lineup_status.json</a>
                  <a href="/lineup.json" target="_blank" style="font-size: 12px;">lineup.json</a>
                  <a href="/hdhr/debug_lineup" target="_blank" style="font-size: 12px;">debug_lineup</a>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
      </div>
      {% endfor %}


      <!-- Add new item -->
      <h2>‚ûï Add New IPTV Configuration</h2>
      <div class="add-new-form">
        <form method="POST" action="/">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="name">Configuration Name</label>
              <input
                type="text"
                id="name"
                name="name"
                placeholder="My IPTV Service"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="server_url">Server URL</label>
              <input
                type="text"
                id="server_url"
                name="server_url"
                placeholder="http://cf.vtsp.cyou:8080"
                maxlength="50"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="username">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                placeholder="your_username"
                maxlength="50"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="user_pass">Password</label>
              <input
                type="text"
                id="user_pass"
                name="user_pass"
                placeholder="your_password"
                maxlength="50"
                required
              />
            </div>
          </div>

          <button type="submit" name="add" value="add">‚ûï Add Configuration</button>
        </form>
      </div>
    </div>
    <!-- End container -->

    <script>
      function toggleMacOSInstructions(button) {
        console.log('Toggle function called');
        const instructions = document.getElementById('macos-instructions');
        console.log('Instructions element:', instructions);
        
        if (!instructions) {
          console.error('Could not find macos-instructions element');
          return;
        }
        
        if (instructions.style.display === 'none' || instructions.style.display === '') {
          instructions.style.display = 'block';
          button.innerHTML = '‚ñº macOS: Auto-discovery disabled (click to hide)';
        } else {
          instructions.style.display = 'none';
          button.innerHTML = '‚ö†Ô∏è macOS: Auto-discovery disabled (click for details)';
        }
      }
      
      function copyStreamUrl(itemId) {
        const streamUrlElement = document.getElementById(
          `stream-url-text-${itemId}`
        );
        if (!streamUrlElement) {
          console.error("Stream URL element not found for item:", itemId);
          return;
        }

        const streamUrl = streamUrlElement.textContent.trim();

        if (!streamUrl) {
          console.error("Stream URL is empty for item:", itemId);
          return;
        }

        console.log("Copying URL:", streamUrl); // Debug log

        navigator.clipboard
          .writeText(streamUrl)
          .then(function () {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.backgroundColor = "#45a049";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.backgroundColor = "#4CAF50";
            }, 2000);
          })
          .catch(function (err) {
            console.error("Could not copy text: ", err);
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = streamUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.backgroundColor = "#45a049";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.backgroundColor = "#4CAF50";
            }, 2000);
          });
      }

      function copyEpgUrl(itemId) {
        const epgUrl = "{{ base_url }}/stream_epg/" + itemId;

        navigator.clipboard
          .writeText(epgUrl)
          .then(function () {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.backgroundColor = "#45a049";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.backgroundColor = "#4CAF50";
            }, 2000);
          })
          .catch(function (err) {
            console.error("Could not copy text: ", err);
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = epgUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.backgroundColor = "#45a049";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.backgroundColor = "#4CAF50";
            }, 2000);
          });
      }
    </script>
  </body>
</html>
